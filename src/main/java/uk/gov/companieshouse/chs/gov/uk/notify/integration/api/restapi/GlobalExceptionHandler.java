package uk.gov.companieshouse.chs.gov.uk.notify.integration.api.restapi;

import jakarta.validation.ConstraintViolationException;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler;
import uk.gov.companieshouse.logging.Logger;

import java.util.Map;

import static uk.gov.companieshouse.chs.gov.uk.notify.integration.api.ChsGovUkNotifyIntegrationService.APPLICATION_NAMESPACE;

@ControllerAdvice
public class GlobalExceptionHandler extends ResponseEntityExceptionHandler {

    /**
     * Map of message (part) substitutions to make message more meaningful to human readers.
     * Workaround for fact we probably cannot provide a more meaningful message in
     * the @Pattern annotation in code generated by OpenAPI Generator.
     */
    private static final Map<String, String>
            ERROR_MESSAGE_PARAMETER_NAME_SUBSTITUTIONS =
            Map.of("sendLetter.arg1", "context ID (X-Request-ID)");

    private final Logger logger;

    public GlobalExceptionHandler(Logger logger) {
        this.logger = logger;
    }

    /**
     * Returns HTTP Status 400 Bad Request when there is an exception implying that
     * the incoming request content is invalid.
     *
     * @param cve exception thrown when input from request is found to be invalid
     * @return response with payload reporting underlying cause
     */
    @ExceptionHandler(ConstraintViolationException.class)
    public ResponseEntity<Object> handleConstraintViolationException(
            final ConstraintViolationException cve) {
        final String message = "Error in " + APPLICATION_NAMESPACE + ": "
                + getSanitisedMessage(cve.getMessage());
        logger.error("Will handle error `" + message + "` by responding with 401 Bad Request.");
        return ResponseEntity.status(HttpStatus.BAD_REQUEST)
                .body(message);
    }

    /**
     * Provides a more legible/meaningful substitution for part of a message originating from a
     * low level exception.
     * 
     * @param exceptionMessage the message provided by the intercepted exception
     * @return the sanitised version of the message
     */
    private String getSanitisedMessage(String exceptionMessage) {
        var newMessage = exceptionMessage;
        for (Map.Entry<String, String> entry :
                ERROR_MESSAGE_PARAMETER_NAME_SUBSTITUTIONS.entrySet()) {
            newMessage = newMessage.replace(entry.getKey(), entry.getValue());
        }
        return newMessage;
    }
}
